/*
 * ClientWrapper: the socket-based client to issue local requests and receive responses by multiple threads (thread safe).
 *
 * Note: requests are generated by an underlying workload (e.g., CacheBench), while each client worker just converts generated requests into network packets to test remote cache.
 * 
 * NOTE: ClientWrapper relies on edge settings in Param to calculate closest edge network address and send requests.
 * 
 * By Siyuan Sheng (2023.04.17).
 */

#ifndef CLIENT_WRAPPER_H
#define CLIENT_WRAPPER_H

#include <string>

#include "benchmark/client_param.h"
#include "network/network_addr.h"
#include "network/propagation_simulator_param.h"
#include "statistics/client_statistics_tracker.h"
#include "workload/workload_wrapper_base.h"

namespace covered
{
    class ClientWrapper
    {
    public:
        static void* launchClient(void* client_param_ptr);

        // NOTE: set NodeParamBase::node_initialized_ after all time-consuming initialization in constructor and start()

        ClientWrapper(const uint32_t& clientcnt, const uint32_t& edgecnt, const uint32_t& keycnt, const uint32_t& opcnt, const uint32_t& perclient_workercnt, const uint32_t& propagation_latency_clientedge_us, const std::string& workload_name, ClientParam* client_param_ptr);
        ~ClientWrapper();

        void start();

        friend class ClientWorkerWrapper;
    private:
        static const std::string kClassName;

        void finishInitialization_() const;

        void checkPointers_() const;

        // Const shared variable
        const uint32_t clientcnt_;
        const uint32_t edgecnt_;
        const uint32_t perclient_workercnt_;
        ClientParam* client_param_ptr_; // thread safe

        // Const individual variable
        std::string instance_name_;

        // Non-const shared variables
        WorkloadWrapperBase* workload_generator_ptr_; // thread safe
        ClientStatisticsTracker* client_statistics_tracker_ptr_; // thread safe
        PropagationSimulatorParam* client_toedge_propagation_simulator_param_ptr_; // thread safe

        // Non-const individual variables for benchmark control messages
        NetworkAddr client_recvmsg_source_addr_;
        NetworkAddr evaluator_recvmsg_dst_addr_;
        UdpMsgSocketServer* client_recvmsg_socket_server_ptr_;
        UdpMsgSocketClient* client_sendmsg_socket_client_ptr_;
    };
}

#endif